name: Build and Release

permissions:
  contents: write
  checks: write
  statuses: write

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]
  workflow_dispatch: {}

jobs:
  # 1. SETUP & RELEASE INFO
  setup:
    name: Prepare Release
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      tag_name: ${{ steps.release_info.outputs.tag_name }}
      title: ${{ steps.release_info.outputs.title }}
      prerelease: ${{ steps.release_info.outputs.prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Release Info
        id: release_info
        run: |
          if [[ "${{ github.event.head_commit.message }}" == *"release"* ]]; then
            echo "tag_name=release-${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "title=Production Release #${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
          else
            echo "tag_name=pre-release-${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "title=Development Build #${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
          fi

  # 2. BUILD FOR EACH OS
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: [setup]
    if: always() && (needs.setup.result == 'success' || needs.setup.result == 'skipped')
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Setup Maven Toolchains
        shell: bash
        run: |
          mkdir -p ~/.m2
          echo '<?xml version="1.0" encoding="UTF8"?><toolchains><toolchain><type>jdk</type><provides><version>17</version></provides><configuration><jdkHome>${{ env.JAVA_HOME }}</jdkHome></configuration></toolchain></toolchains>' > ~/.m2/toolchains.xml

      - name: Build with Maven
        shell: bash
        working-directory: WorldPainter
        run: mvn install -Dci -DskipTests -B

      - name: Copy Dependencies
        shell: bash
        working-directory: WorldPainter
        run: mvn dependency:copy-dependencies -DoutputDirectory=target/libs -pl WPGUI -Dci

      - name: Prepare jpackage input
        shell: bash
        run: |
          mkdir -p dist
          # We need to find the WPGUI jar
          WPGUI_JAR=$(find WorldPainter/WPGUI/target -name "WPGUI-*.jar" | head -n 1)
          cp $WPGUI_JAR dist/WPGUI.jar
          # Copy dependencies
          mkdir -p dist/libs
          cp WorldPainter/WPGUI/target/libs/*.jar dist/libs/ || true

      - name: Build Installer (Linux)
        if: runner.os == 'Linux'
        run: |
          jpackage \
            --input dist \
            --name WorldPainter \
            --main-jar WPGUI.jar \
            --main-class org.pepsoft.worldpainter.Main \
            --type app-image \
            --dest output \
            --java-options "-Djava.library.path=libs" \
            --module-path dist/libs \
            --add-modules ALL-MODULE-PATH

          # Archive the app image
          tar -czf WorldPainter-Linux.tar.gz -C output WorldPainter

      - name: Build Installer (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          jpackage ^
            --input dist ^
            --name WorldPainter ^
            --main-jar WPGUI.jar ^
            --main-class org.pepsoft.worldpainter.Main ^
            --type app-image ^
            --dest output ^
            --java-options "-Djava.library.path=libs" ^
            --module-path dist/libs ^
            --add-modules ALL-MODULE-PATH

          powershell Compress-Archive -Path output\WorldPainter -DestinationPath WorldPainter-Windows.zip

      - name: Build Installer (macOS)
        if: runner.os == 'macOS'
        run: |
          jpackage \
            --input dist \
            --name WorldPainter \
            --main-jar WPGUI.jar \
            --main-class org.pepsoft.worldpainter.Main \
            --type dmg \
            --dest output \
            --java-options "-Djava.library.path=libs" \
            --module-path dist/libs \
            --add-modules ALL-MODULE-PATH

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: WorldPainter-${{ matrix.os }}
          path: |
            WorldPainter-Linux.tar.gz
            WorldPainter-Windows.zip
            output/*.dmg

  # 3. RELEASE
  release:
    name: Create Release
    needs: [setup, build]
    if: needs.setup.outputs.tag_name != '' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Display structure of downloaded files
        run: ls -R

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.setup.outputs.tag_name }}
          name: ${{ needs.setup.outputs.title }}
          prerelease: ${{ needs.setup.outputs.prerelease }}
          files: |
            WorldPainter-ubuntu-latest/WorldPainter-Linux.tar.gz
            WorldPainter-windows-latest/WorldPainter-Windows.zip
            WorldPainter-macos-latest/*.dmg
